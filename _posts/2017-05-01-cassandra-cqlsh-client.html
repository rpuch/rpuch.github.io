---
layout: post
title: Cassandra cqlsh client, OperationTimedOut and request timeouts
date: '2017-05-01T21:55:00.001+03:00'
author: rpuchkovskiy
tags:
- Cassandra
- OperationTimedOut
- cqlsh
- request timeout
modified_time: '2017-05-01T21:55:32.907+03:00'
blogger_id: tag:blogger.com,1999:blog-4160252863216482620.post-7761701281272675461
blogger_orig_url: https://rpuchkovskiy.blogspot.com/2017/05/cassandra-cqlsh-client.html
---

I'm used to mysql command line client. If a query runs for a long time, it just keeps running. This is very useful if you feed a script (i.e. a sequence of queries) to mysql client for execution: no matter how long each query executes, the queries are run serially. If nothing breaks in the middle, they all execute successfully<br /><br />It turned out that with the default settings Cassandra's <b>cqlsh</b> (command line client) behaves differently. All of a sudden, my script (a sequence of DDL queries run in the beginning of an integration test to prepare database) has failed. The first error was&nbsp;<b>OperationTimedOut</b>, but the following ones were caused by the fact that the first query did not yet finish. For example, in my case the first query was <span style="font-family: Courier New, Courier, monospace;">DROP KEYSPACE</span>, while the second was <span style="font-family: Courier New, Courier, monospace;">CREATE KEYSPACE</span> with the same name. Of course, if failed, and the following <span style="font-family: Courier New, Courier, monospace;">CREATE TABLE</span>&nbsp; queries failed as well.<br /><br />Why does this happen? Because cqlsh has a limit (by default it is 10 seconds, according to <a href="https://docs.datastax.com/en/cql/3.3/cql/cql_reference/cqlsh.html" target="_blank">documentation</a>). If your query runs more than this limit, the client just fails with <b>OperationTimedOut</b> error message, but the query is still running on the server.<br /><br />OK, how do we disable this limit, or at least configure it to be long enough?<br /><br />Good news: cqlsh in Cassandra 2.1.16 has <span style="font-family: Courier New, Courier, monospace;">--request-timeout</span> command line parameter and you can specify the limit there (in seconds). <span style="font-family: Courier New, Courier, monospace;">--request-timeout 3600</span> would be a good start.<br /><br />Bad news: cqlsh in Cassandra 2.1.12 does NOT have that parameter yet, so this parameter is not that universal.<br /><br /><blockquote class="tr_bq">By the way, version reported by cqlsh (with the usual <span style="font-family: Courier New, Courier, monospace;">--version</span>) is strange. I tried it with cqlsh included into Cassandra distribution for Cassandra 2.1.8, 2.1.12, 2.1.16, and in all these cases the version was reported as 5.0.1, even though 2.1.16 reports support for <span style="font-family: Courier New, Courier, monospace;">--request-timeout</span> (and really supports it) and the other two versions don't.</blockquote><br />But let's return to out limit.<br /><br />Good news: <span style="font-family: Courier New, Courier, monospace;">~/.cassandra/cqlshrc</span> file allows to define this timeout in <a href="http://docs.datastax.com/en/cql/3.1/cql/cql_reference/cqlshrc.html" target="_blank">[connection] section</a>.<br /><br />Bad news: the documentation is not accurate. Although it says that the option was added in version 2.1.1 and is called <span style="font-family: Courier New, Courier, monospace;">request_timeout</span>, and this is true for 2.1.16, it is NOT true for 2.1.12. In it, you have to call the option <span style="font-family: Courier New, Courier, monospace;">client_timeout</span>. Moreover: in 2.1.12, according to <a href="https://playwithcassandra.wordpress.com/2015/11/05/cqlsh-increase-timeout-limit/" target="_blank">this article</a>, you could completely disable the timeout by assigning <span style="font-family: Courier New, Courier, monospace;">None</span>. Alas, in 2.1.16 (with <span style="font-family: Courier New, Courier, monospace;">request_timeout</span>) this does not work.<br /><br />It is not possible to (reliably) completely disable the timeout. If you set <span style="font-family: Courier New, Courier, monospace;">request_timeout</span> to 0, this will mean that <b>any</b>&nbsp;request will timeout. Negative values cause errors. So the only option is to set it to some large value (like the abovementioned 3600 seconds).<br /><br />So, a kinda universal way to make sure your integration tests don't stumble upon this, is to put the following in your <span style="font-family: Courier New, Courier, monospace;">~/.cassandra/cqlshrc</span>:<br /><br /><span style="font-family: Courier New, Courier, monospace;">[connection]</span><br /><span style="font-family: Courier New, Courier, monospace;">request_timeout = 3600</span><br /><span style="font-family: Courier New, Courier, monospace;">client_timeout = 3600</span><br /><br />BTW, how come that <span style="font-family: Courier New, Courier, monospace;">DROP KEYSPACE</span> for a keyspace with a few tables with no data in them where the cluster contains just one node could not fit into the default timeout (presumably 10 seconds) on a machine with a decent HDD which was not overloaded? It's a different story...