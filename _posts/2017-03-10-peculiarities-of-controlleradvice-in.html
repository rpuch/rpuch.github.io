---
layout: post
title: Peculiarities of @ControllerAdvice in Spring MVC
date: '2017-03-10T23:07:00.000+03:00'
author: rpuchkovskiy
tags:
- "@ControllerAdvice"
- spring-mvc
- peculiarities
- "@ExceptionHandler"
modified_time: '2017-03-10T23:07:19.687+03:00'
blogger_id: tag:blogger.com,1999:blog-4160252863216482620.post-6742828658983487732
blogger_orig_url: https://rpuchkovskiy.blogspot.com/2017/03/peculiarities-of-controlleradvice-in.html
---

<h3>What is @ControllerAdvice?</h3><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ControllerAdvice</span> annotation is used to define some attributes for many <a href="https://github.com/spring-projects/spring-framework" target="_blank">Spring</a> controllers (<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@Controller</span>) at a time.<br /><br />For example, it can be used for a centralized exception control (with <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ExceptionHandler</span> annotation). This post will concentrate on this use.<br /><h3>Global and specific advices</h3>If a <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ControllerAdvice</span> does not have any selectors specified via annotation attritubes, it defines a global advice which affects all the controllers, and its <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ExceptionHandler</span> will catch all the exceptions thrown with handle methods (and not just these exceptions, see below).<br /><br />In <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/new-in-4.0.html" target="_blank">Spring 4.0</a>, the ability to define specific advices was added. <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ControllerAdvice</span> now has some <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/bind/annotation/ControllerAdvice.java" target="_blank">attributes</a> with which we can define advice selectors. These selectors define the scope of the advice, i.e. the exact set of controllers which will be adviced by it.<br /><h3>Global @ExceptionHandler catches 'no man's' exceptions</h3>'No man's' exceptions are exceptions which occur before the handler to process the request is obtained.<br /><br />So, if we don't specify any attributes at <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ControllerAdvice</span> annotation, its <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ExceptionHandler</span> method will catch even <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">HttpRequestMethodNotSupportedException</span> when someone tries to issue a GET request to our POST-only controller.<br /><br />But if we define a class, annotation or an <b>existing</b> basePackage, then the advice will not be global anymore and will not catch 'no man's' exceptions.<br /><h3>basePackages does not work for controllers proxied with Proxy</h3>To have the ability to intercept controller invocations (for example, to handle exceptions), our advice has to wrap controller instance in a proxy. Proxy creation options:<br /><ol><li>If the controller class has at least one implemented interface, an interface-based proxy is created using <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Proxy</span> class.</li><li>If the controller class does not implement any inferfaces, then <a href="https://github.com/cglib/cglib" target="_blank">CGLIB</a> is used; proxy class is created at runtime; this class extends our initial controller class.</li></ol>For CGLIB option, Spring's <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/web/method/ControllerAdviceBean.java" target="_blank">ControllerAdviceBean</a></span> determines correctly the controller class package: it just takes the superclass of CGLIB-generated class (this will be the real controller class as written by us) and then takes its package. In this case, <i>basePackages</i> of <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ControllerAdvice</span> works correctly.<br /><br />But for the interface-proxy based option Spring has no ability to determine the real class of an instance wrapped with <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Proxy</span>, so it tries to take the package of the <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Proxy</span> instance. But <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">proxy.getClass().getPackage()</span> returns <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">null</span>! In Spring 4.0.5 this even causes a <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">NullPointerException</span>. In 4.0.9 the NPE was fixed, but the package will not be determined correctly, so <i>basePackages</i> will not work.<br /><br />To sum up:<br /><br /><ol><li>If the controller class has at least one implemented interface, an interface-based proxy is created using <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Proxy</span> class, and <i>basePackages</i> of <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ControllerAdvice</span> <b>DOES NOT</b> work.</li><li>If the controller class does not implement any inferfaces, then CGLIB is used and <i>basePackages</i>&nbsp;attribute works.</li></ol><br /><h3>What can we do?</h3>Use <i>annotations</i> attribute. First, let's create an annotation like<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #555555; font-weight: bold;">@ControllerAdvicedByMyAdvice</span><br /></pre></div><br />Then we annotate with this annotation all the controllers to which we want to apply the advice. And then we annotate the advice:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #555555; font-weight: bold;">@ControllerAdvice</span><span style="color: #333333;">(</span>annotations <span style="color: #333333;">=</span> <span style="color: #333333;">{</span>ControllerAdvicedByMyAdvice<span style="color: #333333;">.</span><span style="color: #0000cc;">class</span><span style="color: #333333;">})</span><br /></pre></div><br />This approach seems more reliable than the utilization of <i>basePackages</i> attribute.