---
layout: post
title: 'Streaming h264 video from Cloudfront to Flash Player: how-to'
date: '2010-04-08T21:40:00.000+04:00'
author: rpuchkovskiy
tags:
- Flash h264 rtmp Cloudfront streaming video correct url
modified_time: '2010-04-08T21:43:08.667+04:00'
blogger_id: tag:blogger.com,1999:blog-4160252863216482620.post-3448504151231608251
blogger_orig_url: https://rpuchkovskiy.blogspot.com/2010/04/streaming-h264-video-from-cloudfront-to.html
---

Flash makes it easy to stream a video, at least in theory. With <a href="http://aws.amazon.com/cloudfront/">Amazon Cloudfront</a> it's even easier - you just create a bucket, upload a video to it, and it's ready to be streamed via Flash Player.<br />Or it seems so. <br />There're some details which are documented poorly. I will try to fill this hole.<br /><h2>Brief algorithm</h2>To stream a video (including h264) from Cloudfront, you need to do the following:<br /><ol><li>Create an AWS account</li><li>Create an S3 bucket for you videos</li><li>Create a Cloudfront distribution for it</li></ol>Then, for each file you wish to stream, you will have to do the following:<br /><ol><li>Upload it to your S3 bucket as a <b>public resource</b></li><li>Stream it through Flash Player using <span style="font-weight: bold;">correct URL</span></li></ol>Let's go!<br /><h2>Configuring software</h2>To work with S3 and Cloudfront you need some special software. For instance, there's an extension for Firefox called <a href="https://addons.mozilla.org/ru/firefox/addon/3247">S3Fox</a>. I personally prefer using s3cmd command line program to manage S3, I will provide examples for s3cmd.<br />Anyway, when registering in AWS, you will get a couple of pretty long and ugly strings. Those are Access Key and Secret Key. You have to configure your AWS-related software to use these keys for authentication. For s3cmd, the command is<br /><blockquote style="font-family: courier new;">s3cmd --configure</blockquote><h2>Creating an AWS account<br /></h2>To create an AWS (<a href="https://aws.amazon.com/">Amazon Web Services</a>) account.<br /><h2>Creating an S3 bucket for your videos</h2>First, you have to create an S3 (<a href="http://aws.amazon.com/s3/">Simple Storage Service</a>) bucket for your videos, it will feed them to your Cloudfront distributions.<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;">s3cmd mb s3://your-bucket-name.you-site.com</blockquote>Bucket name must be unique among all buckets, so it may seem reasonable to call your bucket based on your domain name.<br /><h2>Creating a Cloudfront distribution for your videos</h2>A distribution must be bound to a bucket. Distribution will distribute any file with public access from a bucket bound to it.<br />Distribution may be created using mentioned software or using <a href="https://console.aws.amazon.com/">AWS Console</a> web interface.<br />When creating, select 'Streaming' as type as we're going to stream video. Note that you can create several distributions for your bucket, so you may also have access to your bucket via HTTP if you wish. Of course, specify your bucket to which distribution will be bound.<br />Distribution takes some time to create. After it completes, you will get a public domain name for it, this will be domain name you will need to construct video URLs.<br /><br /><h2>Uploading a video to bucket</h2>When uploading a video to your bucket, make sure that you make it <b>publicly readable</b>.<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;">s3cmd --acl-public put video.mp4 s3://your-bucket-name.your-site.com/video.mp4</blockquote>Note that you <b>don't</b> need to make your whole <b>bucket</b> publicly readable, only files.<br /><h2>Constructing a URL</h2>It's not a trivial task to construct a correct URL for streaming, because RTMP (and we are forced to use RTMP for streaming) has its own logic of constructing URLs. And there's still another catch with correct format prefix which you <b>must</b> use if you stream mp4 (or mp3). So I will provide some examples.<br />The common schema for Cloudfront is the following:<br /><blockquote>rtmp://distribution-domain-name/cfx/st/[type_prefix]stream_name</blockquote><ul><li>for flv, you don't need a type prefix, and you may supply extension name while it's recommented to omit it.</li><li>for mp4, you have to use type prefix 'mp4:' (with no quotes) and you must supply extension (mov, mp4, aac, f4v, m4v, m4a - any of these).</li><li>for mp3, you have to use type prefix 'mp3:'.</li></ul>Let's assume you have some video and audio files stored as s3://your-bucket-name.your-site.com/video1.flv, s3://your-bucket-name.your-site.com/video2.mp4 and s3://your-bucket-name.your-site.com/audio.mp3. Assuming that your Cloudfront distribution domain name is abcdefghijklmn.cloudfront.net, you'll have to use the following URLs:<br /><blockquote>rtmp://abcdefghijklmn.cloudfront.net/cfx/st/video1<br />rtmp://abcdefghijklmn.cloudfront.net/cfx/st/mp4:video2.mp4<br />rtmp://abcdefghijklmn.cloudfront.net/cfx/st/mp3:audio.mp3</blockquote><h2>Links</h2><a href="http://livedocs.adobe.com/flex/3/langref/flash/net/NetStream.html#play%28%29">http://livedocs.adobe.com/flex/3/langref/flash/net/NetStream.html#play()</a> - here is more info on type prefixes