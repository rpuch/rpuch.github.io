---
layout: post
title: Testing an Aspect in a Spring application
date: '2019-06-09T20:46:00.001+03:00'
author: rpuchkovskiy
tags:
- testing
- spring
- aspect
- java
modified_time: '2019-06-09T20:46:14.024+03:00'
blogger_id: tag:blogger.com,1999:blog-4160252863216482620.post-2574041500572598954
blogger_orig_url: https://rpuchkovskiy.blogspot.com/2019/06/testing-aspect-in-spring-application.html
---

Sometimes, an Aspect is the best tool to solve a task at hand. But how can we unit-test it? An obvious solution is to start up the whole application context, including the Aspect, and then test how it behaves, but this will be actually an integration test; such tests are heavy, and you have less control over the situations you can model in such a test (for example, it may be pretty difficult to simulate an exceptional situation).
<br /><br />
Actually, there are two things that are interesting from the testing perspective an an aspect:<br /><br /><ol><li>The business logic that the aspect executes when triggered</li><li>The pointcut expression(s) which trigger aspect execution</li></ol><br />Even the first of them is not so easy to test because you need an instance of <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">ProceedingJoinPoint</span> which is cumbersome to implement or mock (and it is not recommended to mock external interfaces, as it is explained in <a href="http://www.informit.com/store/growing-object-oriented-software-guided-by-tests-9780321503626" target="_blank">Growing Object-Oriented Software, Guided by Tests</a>, for example).<br /><br /><h3>The solution</h3><br />Let's imagine that we have an aspect that must throw an exception if a method's first argument is <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">null</span>, otherwise allow the method invocation proceed.<br /><br />It should only be applied to controllers annotated with our custom <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">@ThrowOnNullFirstArg</span> annotation.<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #555555; font-weight: bold;">@Aspect</span><br /><span style="color: #008800; font-weight: bold;">public</span> <span style="color: #008800; font-weight: bold;">class</span> <span style="color: #bb0066; font-weight: bold;">ThrowOnNullFirstArgAspect</span> <span style="color: #333333;">{</span><br />    <span style="color: #555555; font-weight: bold;">@Pointcut</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">""</span> <span style="color: #333333;">+</span><br />            <span style="background-color: #fff0f0;">"within(@org.springframework.stereotype.Controller *) || "</span> <span style="color: #333333;">+</span><br />            <span style="background-color: #fff0f0;">"within(@(@org.springframework.stereotype.Controller *) *)"</span><span style="color: #333333;">)</span><br />    <span style="color: #008800; font-weight: bold;">private</span> <span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">isController</span><span style="color: #333333;">()</span> <span style="color: #333333;">{}</span><br /><br />    <span style="color: #555555; font-weight: bold;">@Around</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"isController()"</span><span style="color: #333333;">)</span><br />    <span style="color: #008800; font-weight: bold;">public</span> Object <span style="color: #0066bb; font-weight: bold;">executeAroundController</span><span style="color: #333333;">(</span>ProceedingJoinPoint point<span style="color: #333333;">)</span> <span style="color: #008800; font-weight: bold;">throws</span> Throwable <span style="color: #333333;">{</span><br />        throwIfNullFirstArgIsPassed<span style="color: #333333;">(</span>point<span style="color: #333333;">);</span><br />        <span style="color: #008800; font-weight: bold;">return</span> point<span style="color: #333333;">.</span><span style="color: #0000cc;">proceed</span><span style="color: #333333;">();</span><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #008800; font-weight: bold;">private</span> <span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">throwIfNullFirstArgIsPassed</span><span style="color: #333333;">(</span>ProceedingJoinPoint point<span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />        <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(!(</span>point<span style="color: #333333;">.</span><span style="color: #0000cc;">getSignature</span><span style="color: #333333;">()</span> <span style="color: #008800; font-weight: bold;">instanceof</span> MethodSignature<span style="color: #333333;">))</span> <span style="color: #333333;">{</span><br />            <span style="color: #008800; font-weight: bold;">return</span><span style="color: #333333;">;</span><br />        <span style="color: #333333;">}</span><br /><br />        <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(</span>point<span style="color: #333333;">.</span><span style="color: #0000cc;">getArgs</span><span style="color: #333333;">().</span><span style="color: #0000cc;">length</span> <span style="color: #333333;">&gt;</span> <span style="color: #0000dd; font-weight: bold;">0</span> <span style="color: #333333;">&amp;&amp;</span> point<span style="color: #333333;">.</span><span style="color: #0000cc;">getArgs</span><span style="color: #333333;">()[</span><span style="color: #0000dd; font-weight: bold;">0</span><span style="color: #333333;">]</span> <span style="color: #333333;">==</span> <span style="color: #008800; font-weight: bold;">null</span><span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />            <span style="color: #008800; font-weight: bold;">throw</span> <span style="color: #008800; font-weight: bold;">new</span> <span style="color: #0066bb; font-weight: bold;">IllegalStateException</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"The first argument is not allowed to be null"</span><span style="color: #333333;">);</span><br />        <span style="color: #333333;">}</span><br />    <span style="color: #333333;">}</span><br /><span style="color: #333333;">}</span><br /></pre></td></tr></tbody></table></div><br />We could test it like so:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br />35<br />36<br />37<br />38<br />39<br />40<br />41</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">public</span> <span style="color: #008800; font-weight: bold;">class</span> <span style="color: #bb0066; font-weight: bold;">ThrowOnNullFirstArgAspectTest</span> <span style="color: #333333;">{</span><br />    <span style="color: #008800; font-weight: bold;">private</span> <span style="color: #008800; font-weight: bold;">final</span> ThrowOnNullFirstArgAspect aspect <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">new</span> ThrowOnNullFirstArgAspect<span style="color: #333333;">();</span><br />    <span style="color: #008800; font-weight: bold;">private</span> TestController controllerProxy<span style="color: #333333;">;</span><br /><br />    <span style="color: #555555; font-weight: bold;">@Before</span><br />    <span style="color: #008800; font-weight: bold;">public</span> <span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">setUp</span><span style="color: #333333;">()</span> <span style="color: #333333;">{</span><br />        AspectJProxyFactory aspectJProxyFactory <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">new</span> AspectJProxyFactory<span style="color: #333333;">(</span><span style="color: #008800; font-weight: bold;">new</span> TestController<span style="color: #333333;">());</span><br />        aspectJProxyFactory<span style="color: #333333;">.</span><span style="color: #0000cc;">addAspect</span><span style="color: #333333;">(</span>aspect<span style="color: #333333;">);</span><br /><br />        DefaultAopProxyFactory proxyFactory <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">new</span> DefaultAopProxyFactory<span style="color: #333333;">();</span><br />        AopProxy aopProxy <span style="color: #333333;">=</span> proxyFactory<span style="color: #333333;">.</span><span style="color: #0000cc;">createAopProxy</span><span style="color: #333333;">(</span>aspectJProxyFactory<span style="color: #333333;">);</span><br /><br />        controllerProxy <span style="color: #333333;">=</span> <span style="color: #333333;">(</span>TestController<span style="color: #333333;">)</span> aopProxy<span style="color: #333333;">.</span><span style="color: #0000cc;">getProxy</span><span style="color: #333333;">();</span><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #555555; font-weight: bold;">@Test</span><br />    <span style="color: #008800; font-weight: bold;">public</span> <span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">whenInvokingWithNullFirstArg_thenExceptionShouldBeThrown</span><span style="color: #333333;">()</span> <span style="color: #333333;">{</span><br />        <span style="color: #008800; font-weight: bold;">try</span> <span style="color: #333333;">{</span><br />            controllerProxy<span style="color: #333333;">.</span><span style="color: #0000cc;">someMethod</span><span style="color: #333333;">(</span><span style="color: #008800; font-weight: bold;">null</span><span style="color: #333333;">);</span><br />            fail<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"An exception should be thrown"</span><span style="color: #333333;">);</span><br />        <span style="color: #333333;">}</span> <span style="color: #008800; font-weight: bold;">catch</span> <span style="color: #333333;">(</span>IllegalStateException e<span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />            assertThat<span style="color: #333333;">(</span>e<span style="color: #333333;">.</span><span style="color: #0000cc;">getMessage</span><span style="color: #333333;">(),</span> is<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"The first argument is not allowed to be null"</span><span style="color: #333333;">));</span><br />        <span style="color: #333333;">}</span><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #555555; font-weight: bold;">@Test</span><br />    <span style="color: #008800; font-weight: bold;">public</span> <span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">whenInvokingWithNonNullFirstArg_thenNothingShouldBeThrown</span><span style="color: #333333;">()</span> <span style="color: #333333;">{</span><br />        String result <span style="color: #333333;">=</span> controllerProxy<span style="color: #333333;">.</span><span style="color: #0000cc;">someMethod</span><span style="color: #333333;">(</span>Descriptor<span style="color: #333333;">.</span><span style="color: #0000cc;">builder</span><span style="color: #333333;">().</span><span style="color: #0000cc;">externalId</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"id"</span><span style="color: #333333;">).</span><span style="color: #0000cc;">build</span><span style="color: #333333;">());</span><br /><br />        assertThat<span style="color: #333333;">(</span>result<span style="color: #333333;">,</span> is<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"ok"</span><span style="color: #333333;">));</span><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #555555; font-weight: bold;">@Controller</span><br />    <span style="color: #555555; font-weight: bold;">@ThrowOnNullFirstArg</span><br />    <span style="color: #008800; font-weight: bold;">private</span> <span style="color: #008800; font-weight: bold;">static</span> <span style="color: #008800; font-weight: bold;">class</span> <span style="color: #bb0066; font-weight: bold;">TestController</span> <span style="color: #333333;">{</span><br />        <span style="color: #555555; font-weight: bold;">@SuppressWarnings</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"unused"</span><span style="color: #333333;">)</span><br />        String <span style="color: #0066bb; font-weight: bold;">someMethod</span><span style="color: #333333;">(</span>Descriptor descriptor<span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />            <span style="color: #008800; font-weight: bold;">return</span> <span style="background-color: #fff0f0;">"ok"</span><span style="color: #333333;">;</span><br />        <span style="color: #333333;">}</span><br />    <span style="color: #333333;">}</span><br /><span style="color: #333333;">}</span><br /></pre></td></tr></tbody></table></div><br /><br />The key part is inside the <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">setUp()</span> method. Please note that it also allows to verify the correctness of your pointcut expression, so it solves both problems.<br /><br />Of course, in a real project it is better to extract the 'proxy contstruction' code to some helper class to avoid code duplication and make the intentions clearer.
